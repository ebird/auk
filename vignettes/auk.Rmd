---
title: "auk: eBird Data Processing with AWK"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE, error = FALSE,
  fig.path = "README-"
)
```

[eBird](http://www.ebird.org) is an online tool for recording bird observations. Since its inception, nearly 500 million sightings records have been collected, making it one of the largest citizen science projects in history and an extremely valuable resource for bird research and conservation. The full eBird database is packaged as a text file and available for download as the [eBird Basic Dataset (EBD)](http://ebird.org/ebird/data/download). Due to the large size of this dataset, it must be filtered to a smaller subset of desired observations before reading into R. This subsetting is most efficiently done using AWK, a unix utility and programming language for processing column formatted text data. This package acts as a front end for AWK, allowing users to filter eBird data before import into R.

This vignette is divided into three sections. The first second provides background on the eBird data and motivation for the development of this package. The second section outlines the use of `auk` for filtering the EBD to produce a presence-only dataset. The final section demonstrates how `auk` can be used to produce zero-filled, presence-absence data, a necessity for many modeling and analysis applications.

## Background

### The eBird Basic Dataset

The eBird database currently contains nearly 500 million bird observations, and this rate of increase is accelerating as new users join eBird. These data are an extremely valuable tool both for science and conservation, however, given the sheer amount of data, accessing eBird data poses a unique challenge. Currently, access to the complete set of eBird observations is provided via the eBird Basic Dataset (EBD). This is a tab-separated text file, released quarterly, containing all validated bird sighting in the eBird databsae at the time of release. Each row corresponds to the sighting of a single species within a checklist and, in addition to the species and number of individuals observed, information is provided at the checklist level (location, time, date, search effort, etc.).

In addition to the EBD, eBird provides a Sampling Event Data file, which contains a record of every checklist submitted to eBird. In this file, each row corresponds to a checklist and only the checklist-level variables are included, not the associated bird data. While the EBD provides presenece-only data, the EBD and Sampling Event Data must be combined to produce presence-absence data. This process is described below.

For Full metadata on the EBD and Sampling Event Data, consult the documentation provided when the [file is downloaded](http://ebird.org/ebird/data/download).

### Data access

To access the EBD, begin by [creating an eBird account and signing in](https://secure.birds.cornell.edu/cassso/login). Then visit the [Download Data](http://ebird.org/ebird/data/download) page. eBird data access is free, however, you will need to [request access](http://ebird.org/ebird/data/request). Filling out the access request form allows eBird to keep track of who's using the data and for what applications.

Once you have access to the data, proceed to the [download page](http://ebird.org/ebird/data/download/ebd). There are two download options: prepackage download and custom download. Downloading the prepackaged option gives you access to the full global dataset. If you choose this route, you'll likely want to download both the EBD (~ 25 GB) and corresponding Sampling Event Data (~ 2.5 GB). If you know you're likely to only need data for a single species, or a small region, you can request a custom download be prepared consisting of only a subset of the data. This will result in significantly smaller files, however, note that custom requests that would result in huge numbers of checklists (e.g. all records from the US) won't work. In either case, download and decompress the files.

### Example data

This package comes with two example datasets. The first is suitable for practicing filtering the EBD and producing presence-only data. It's a sample of 500 records from the EBD. It contains data from North and Central America from 2010-2012 on 4 Jay species: Gray Jay, Blue Jay, Steller's Jay, and Green Jay. It can be access with:

```{r example-data-1, eval = FALSE}
system.file("extdata/ebd-sample.txt", package = "auk")
```

The second is suitable for producing zero-filled, presence-absence data. It contains every sighting from Singapore in 2012 of Collared Kingfisher, White-throated Kingfisher, and Blue-eared Kingfisher. In addition to this sightings data, the full Sampling Event Data file is included containing all checklists from Singapore in 2012. These files can be accessed with:

```{r example-data-2, eval = FALSE}
# ebd
system.file("extdata/zerofill-ex_ebd.txt", package = "auk")
# sampling event data
system.file("extdata/zerofill-ex_sampling.txt", package = "auk")
```

### AWK

R typically works with objects in memory and, as a result, there is a hard limit on the size of objects that can be brought into R. Because eBird contains nearly 500 million sightings, the EBD is an inherently large file (~150 GB uncompressed) and therefore impossible to manipulate directly in R. Therefore it is generally necessary to subset the EBD outside of R, then import the smaller subset for analysis.

AWK is a unix utility and programming language for processing column formatted text data. It is highly flexible and extremely fast, making it a valuable tool for pre-processing the EBD. Users of the EBD can use AWK to subset the full text file taxonomically, spatially, or temporally, to produce a smaller file, which can then be loaded in to R for visualization, analysis, and modelling. 

Although AWK is a powerful tool, it has three disadvantages: it requires learning the syntax of a new language, it is only accessible via the command line, and it results in a portion of your workflow existing outside of R. This package is a wrapper for AWK specifically designed for filtering the EBD. The goal is to ease the use of the EBD by removing the hurdle of learning and using AWK.

Linux and Mac users should already have AWK installed on their machines, however, Windows uses will need to install [Cygwin](https://www.cygwin.com) to gain access to AWK.

## Presence data

The most common use of the EBD is to produce a set of bird sightings, i.e. where and when was a given species seen. For example, this type of data could be used to produce a map of sightings locations or determine if a given bird has been seen in an area of interest. For more analytical work, such as species distribution modeling, presence and absence data are required. Producing presence-absence data will be covered in the next section.

### Cleaning

Some rows in the eBird Basic Dataset (EBD) may have an incorrect number of columns, typically from problematic characters in the comments fields, and the dataset has an extra blank column at the end. The function `auk_clean()` drops these erroneous records and removes the blank column. This process should be run on both the EBD and sampling event data. It typically takes several hours for the full EBD, however, it only needs to be run once.

```{r auk-clean, results = 'hide'}
library(auk)
# sample data, with intentially introduced errors
f <- system.file("extdata/ebd-sample_messy.txt", package="auk")
tmp <- tempfile()
# remove problem records
cleaned <- auk_clean(f, f_out = tmp)
# compare number of lines in input and output
length(readLines(f))
length(readLines(cleaned))
unlink(tmp)
```

### The `auk_ebd` object

This package uses an `auk_ebd` object to keep track of the input EBD file, any filters defined, and the output file after filtering has been executed. By keeping everything wrapped up in an object, the user can keep track of exactly what set of input data and filters produce given output data. To set up the initial `auk_ebd` object, use `auk_ebd()`:

```{r auk-ebd}
ebd <- system.file("extdata/ebd-sample_messy.txt", package="auk") %>% 
  auk_ebd()
ebd
```

### Defining filters

`auk` uses a [pipeline-based workflow](http://r4ds.had.co.nz/pipes.html) for defining filters, which can then be compiled into an AWK script. Any of the following filters can be applied:

- `auk_species()`: filter by species using common or scientific names.
- `auk_country()`: filter by country using the standard Engligh name or [ISO 2-letter country codes](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2).
- `auk_extent()`: filter by spatial extent, i.e. a range of latitudes and longitudes.
- `auk_date()`: filter to checklists from a range of dates.
- `auk_last_edited()`: filter to checklists from a range of last edited dates, useful for extracting just new or recently edited data.
- `auk_time()`: filter to checklists started during a range of times.
- `auk_duration()`: filter to checklists that lasted a given length of time.
- `auk_complete()`: only retain checklists in which the observer has specified that they recorded all species seen or heard. These records are the most useful for modelling because they provide both presence and absenced data.

Note that all of these functions only modify the `auk_ebd` object to define the filters. The filters must be executed separately using `auk_filter()`.

```{r auk-filter}
ebd <- ebd %>% 
  # species: common and scientific names can be mixed
  auk_species(species = c("Gray Jay", "Cyanocitta cristata")) %>%
  # country: codes and names can be mixed; case insensitive
  auk_country(country = c("US", "Canada", "mexico")) %>%
  # extent: formatted as `c(lng_min, lat_min, lng_max, lat_max)`
  auk_extent(extent = c(-100, 37, -80, 52)) %>%
  # date: use standard ISO date format `"YYYY-MM-DD"`
  auk_date(date = c("2012-01-01", "2012-12-31")) %>%
  # time: 24h format
  auk_time(time = c("06:00", "09:00")) %>%
  # duration: length in minutes of checklists
  auk_duration(duration = c(0, 60)) %>%
  # complete: all species seen or heard are recorded
  auk_complete()
ebd
```

In all cases, extensive checks are performed to ensure filters are valid. For example, species are checked against the official [eBird taxonomy](http://help.ebird.org/customer/portal/articles/1006825-the-ebird-taxonomy) and countries are checked using the [`countrycode`](https://github.com/vincentarelbundock/countrycode) package. This is particularly important because filtering is a time consuming process, so catching errors in advance can avoid several hours of time wasted.

### Executing filters

Each of the above functions only defines a filter. Once all filters have been set, `auk_filter()` should be used to compile them into an AWK script and execute it to produce an output file. So, bringing all this together, one could, for example, extract all Gray Jay and Blue Jay records from Canada with:

```{r auk-complete, eval = FALSE}
output_file <- "ebd_filtered_blja-grja.txt"
ebd <- system.file("extdata/ebd-sample.txt", package="auk") %>% 
  auk_ebd() %>% 
  auk_species(species = c("Gray Jay", "Cyanocitta cristata")) %>% 
  auk_country(country = "Canada") %>% 
  auk_filter(file = output_file)
```

**Filtering the full EBD typically takes at least a couple hours**, so set it running then go grab lunch!

### Reading

EBD files can be read with `read_ebd()`. This is a wrapper around `data.table::fread()`, `readr::read_delim()`, or `read.delim()`, depending on which packages are installed. `read_ebd()` uses `stringsAsFactors = FALSE`, `quote = ""`, sets column classes, and converts variable names to `snake_case`.

```{r read}
system.file("extdata/ebd-sample.txt", package="auk") %>% 
  read_ebd() %>% 
  str()
```

By default, `read_ebd()` returns a tibble for use with [Tidyverse](http://tidyverse.org) packages. Tibbles will behave just like plain data frames in most instances, but users can choose to return a plain `data.frame` or `data.table` by using the `setclass` argument.

```{r read-tbl}
ebd_df <- system.file("extdata/ebd-sample.txt", package="auk") %>% 
  read_ebd(setclass = "data.frame")
```

An `auk_ebd` object can also be read directly after passing through `auk_filter()`, allowing for a complete pipeline.

```{r read-auk-ebd, eval = FALSE}
output_file <- "ebd_filtered_blja-grja.txt"
ebd <- system.file("extdata/ebd-sample.txt", package="auk") %>% 
  auk_ebd() %>% 
  auk_species(species = c("Gray Jay", "Cyanocitta cristata")) %>% 
  auk_country(country = "Canada") %>% 
  auk_filter(file = output_file) %>% 
  read_ebd()
```

## Acknowledgements

This package is based on the AWK scripts provided in a presentation given by Wesley Hochachka, Daniel Fink, Tom Auer, and Frank La Sorte at the 2016 NAOC eBird Data Workshop on August 15, 2016.

## References

```
eBird Basic Dataset. Version: ebd_relFeb-2017. Cornell Lab of Ornithology, Ithaca, New York. May 2013.
```
